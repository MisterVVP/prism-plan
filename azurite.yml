x-azurite-storage-env: &azurite-storage-env
  STORAGE_CONNECTION_STRING: ${STORAGE_CONNECTION_STRING_AZURITE:-${STORAGE_CONNECTION_STRING}}

x-azurite-functions-env: &azurite-functions-env
  <<: *azurite-storage-env
  AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING_AZURITE:-${STORAGE_CONNECTION_STRING}}

x-azurite-core-depends: &azurite-core-depends !override
  azurite:
    condition: service_healthy
  storage-init:
    condition: service_completed_successfully

x-azurite-read-model-depends: &azurite-read-model-depends
  <<: *azurite-core-depends
  redis:
    condition: service_started

x-azurite-init-depends: &azurite-init-depends !override
  azurite:
    condition: service_healthy

services:
  azurite:
    command: ["azurite", "-s", "-l", "--skipApiVersionCheck", "/data", "--blobHost", "0.0.0.0", "--tableHost", "0.0.0.0", "--queueHost", "0.0.0.0"]
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"

  fauxzureq:
    ports: !reset null

  prism-api-1:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-storage-env

  prism-api-2:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-storage-env

  prism-api-3:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-storage-env

  prism-api-4:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-storage-env

  prism-api-5:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-storage-env

  domain-service:
    depends_on: *azurite-core-depends
    environment:
      <<: *azurite-functions-env

  read-model-updater:
    depends_on: *azurite-read-model-depends
    environment:
      <<: *azurite-functions-env

  storage-init:
    depends_on: *azurite-init-depends
    environment:
      <<: *azurite-storage-env

volumes:
  azurite_data:

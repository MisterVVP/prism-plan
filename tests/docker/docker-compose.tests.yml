x-prism-api-test-env: &prism-api-test-env
  APP_ENV: test
  AUTH0_TEST_MODE: "1"
  TEST_JWT_SECRET: ${TEST_JWT_SECRET}

x-stream-service-test-env: &stream-service-test-env
  APP_ENV: test
  AUTH0_TEST_MODE: "1"
  TEST_JWT_SECRET: ${TEST_JWT_SECRET}

x-domain-service-test: &domain-service-test
  extends:
    file: docker-compose.yml
    service: domain-service
  environment:
    APP_ENV: test
    AzureFunctionsJobHost__Logging__Console__IsEnabled: false

x-read-model-updater-test: &read-model-updater-test
  extends:
    file: docker-compose.yml
    service: read-model-updater
  environment:
    APP_ENV: test
  expose:
    - "${READ_MODEL_UPDATER_PORT}"

services:
  domain-service: !reset null
  read-model-updater: !reset null

  web:
    extends:
      file: docker-compose.yml
      service: web
    environment:
      APP_ENV: test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5

  prism-api-1:
    extends:
      file: docker-compose.yml
      service: prism-api-1
    environment:
      <<: *prism-api-test-env

  prism-api-2:
    extends:
      file: docker-compose.yml
      service: prism-api-2
    environment:
      <<: *prism-api-test-env

  prism-api-3:
    extends:
      file: docker-compose.yml
      service: prism-api-3
    environment:
      <<: *prism-api-test-env

  prism-api-4:
    extends:
      file: docker-compose.yml
      service: prism-api-4
    environment:
      <<: *prism-api-test-env

  prism-api-5:
    extends:
      file: docker-compose.yml
      service: prism-api-5
    environment:
      <<: *prism-api-test-env

  prism-api-lb:
    extends:
      file: docker-compose.yml
      service: prism-api-lb

  stream-service:
    extends:
      file: docker-compose.yml
      service: stream-service
    environment:
      <<: *stream-service-test-env
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    ports:
      - "${STREAM_SERVICE_PORT}:${STREAM_SERVICE_PORT}"

  domain-service-1:
    <<: *domain-service-test

  domain-service-2:
    <<: *domain-service-test

  domain-service-3:
    <<: *domain-service-test

  domain-service-4:
    <<: *domain-service-test

  domain-service-5:
    <<: *domain-service-test

  domain-service-6:
    <<: *domain-service-test

  domain-service-7:
    <<: *domain-service-test

  domain-service-8:
    <<: *domain-service-test

  domain-service-9:
    <<: *domain-service-test

  domain-service-10:
    <<: *domain-service-test
  

  read-model-updater-1:
    <<: *read-model-updater-test

  read-model-updater-2:
    <<: *read-model-updater-test

  read-model-updater-3:
    <<: *read-model-updater-test

  read-model-updater-lb:
    environment:
      READ_MODEL_UPDATER_PORT: ${READ_MODEL_UPDATER_PORT}
    image: haproxy:3.0-alpine
    volumes:
      - ./haproxy/read-model-updater.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "${READ_MODEL_UPDATER_PORT}:${READ_MODEL_UPDATER_PORT}"
    depends_on:
      - read-model-updater-1
      - read-model-updater-2
      - read-model-updater-3

  storage-init:
    extends:
      file: docker-compose.yml
      service: storage-init
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    restart: "no"

  redis:
    extends:
      file: docker-compose.yml
      service: redis
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy

  azurite:
    extends:
      file: docker-compose.yml
      service: azurite
    command: ["azurite", "-s", "-l", "--inMemoryPersistence", "--skipApiVersionCheck", "/data", "--blobHost", "0.0.0.0"]

volumes:
  azurite_data:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs

x-prism-api-test-env: &prism-api-test-env
  APP_ENV: test
  AUTH0_TEST_MODE: "1"
  TEST_JWT_SECRET: ${TEST_JWT_SECRET}

x-stream-service-test-env: &stream-service-test-env
  APP_ENV: test
  AUTH0_TEST_MODE: "1"
  TEST_JWT_SECRET: ${TEST_JWT_SECRET}

x-prism-api-test: &prism-api-test
  environment:
    <<: *prism-api-test-env
  depends_on:
    azurite:
      condition: service_healthy
    fauxzureq:
      condition: service_healthy

x-domain-service-test: &domain-service-test
  extends:
    file: docker-compose.yml
    service: domain-service-1
  environment:
    APP_ENV: test

x-read-model-updater-test: &read-model-updater-test
  environment:
    APP_ENV: test

services:
  domain-service: !override
    <<: *domain-service-test
    profiles:
      - "disabled"
  
  read-model-updater: !override
    <<: *read-model-updater-test
    profiles:
      - "disabled"

  web:
    extends:
      file: docker-compose.yml
      service: web
    environment:
      APP_ENV: test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5

  prism-api-1:
    <<: *prism-api-test
    extends:
      file: docker-compose.yml
      service: prism-api-1

  prism-api-2:
    <<: *prism-api-test
    extends:
      file: docker-compose.yml
      service: prism-api-2

  prism-api-3:
    <<: *prism-api-test
    extends:
      file: docker-compose.yml
      service: prism-api-3

  prism-api-4:
    <<: *prism-api-test
    extends:
      file: docker-compose.yml
      service: prism-api-4

  prism-api-5:
    <<: *prism-api-test
    extends:
      file: docker-compose.yml
      service: prism-api-5

  stream-service:
    extends:
      file: docker-compose.yml
      service: stream-service
    environment:
      <<: *stream-service-test-env
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    ports:
      - "${STREAM_SERVICE_PORT}:${STREAM_SERVICE_PORT}"

  domain-service-1:
    <<: *domain-service-test

  domain-service-2:
    <<: *domain-service-test

  domain-service-3:
    <<: *domain-service-test

  domain-service-4:
    <<: *domain-service-test

  domain-service-5:
    <<: *domain-service-test 

  read-model-updater-1:
    <<: *read-model-updater-test

  read-model-updater-2:
    <<: *read-model-updater-test

  read-model-updater-3:
    <<: *read-model-updater-test

  fauxzureq:
    image: mistervvp/fauxzureq:main
    command: ["--listen=:10001", "--table-listen=:10002", "--account=devstoreaccount1", "--queue-delete-hold-ms=0", "--http-log=false"]
    ports: ["10001:10001", "10002:10002"]
    sysctls:
        - net.ipv4.tcp_rmem=16384 4194304 536870912
        - net.ipv4.tcp_wmem=16384 4194304 536870912
        - net.core.somaxconn=1048576
        - net.ipv4.tcp_tw_reuse=1
        - net.ipv4.tcp_fin_timeout=1
    ulimits:
      nofile:
        soft: "1048576"
        hard: "1048576"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:10001/__health"]
      interval: 5s
      timeout: 3s
      retries: 5

  idempotency-cleaner:
    extends:
      file: docker-compose.yml
      service: idempotency-cleaner
    environment:
      APP_ENV: test
      IDEMPOTENCY_CLEANER_SCHEDULE: "*/3 * * * * *"
    depends_on:
      storage-init:
        condition: service_completed_successfully
      fauxzureq:
        condition: service_healthy
      azurite:
        condition: service_healthy

  read-model-updater-lb:
    extends:
      file: docker-compose.yml
      service: read-model-updater-lb

  storage-init:
    extends:
      file: docker-compose.yml
      service: storage-init
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    restart: "no"

  redis:
    extends:
      file: docker-compose.yml
      service: redis
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy

  azurite:
    extends:
      file: docker-compose.yml
      service: azurite
    command: ["azurite", "-s", "--inMemoryPersistence", "--skipApiVersionCheck", "--blobHost", "0.0.0.0"]
    ports: !override
      - "10000:10000"

volumes:
  azurite_data:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs

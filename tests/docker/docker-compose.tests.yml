x-prism-api: &prism-api-base
  build:
    context: ./prism-api
  environment: &prism-api-env
    APP_ENV: test
    AUTH0_TEST_MODE: "1"
    TEST_JWT_SECRET: ${TEST_JWT_SECRET}
    REDIS_CONNECTION_STRING: ${REDIS_CONNECTION_STRING}
    TASKS_PAGE_SIZE: ${TASKS_PAGE_SIZE}
    ENQUEUE_WORKERS: ${ENQUEUE_WORKERS}
    ENQUEUE_BUFFER: ${ENQUEUE_BUFFER}
    ENQUEUE_TIMEOUT: ${ENQUEUE_TIMEOUT}
    DEDUPER_TTL: ${DEDUPER_TTL}
  depends_on:
    azurite:
      condition: service_healthy
    fauxzureq:
      condition: service_healthy
    storage-init:
      condition: service_completed_successfully

x-domain-service: &domain-service-base
  build: ./domain-service    
  environment: &domain-service-env
    APP_ENV: test
    STORAGE_CONNECTION_STRING: ${STORAGE_CONNECTION_STRING}
    TASK_EVENTS_TABLE: ${TASK_EVENTS_TABLE}
    USER_EVENTS_TABLE: ${USER_EVENTS_TABLE}
    COMMAND_QUEUE: ${COMMAND_QUEUE}
    DOMAIN_EVENTS_QUEUE: ${DOMAIN_EVENTS_QUEUE}
    READ_MODEL_UPDATER_URL: ${READ_MODEL_UPDATER_URL}
    AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING}
    AzureWebJobsScriptRoot: /home/site/wwwroot
    AzureFunctionsJobHost__Logging__Console__IsEnabled: false
    AzureFunctionsJobHost__Logging__LogLevel__Default: ${AZ_FUNC_JOB_HOST_LOG_LEVEL}
  depends_on:
    fauxzureq:
      condition: service_healthy    
    azurite:
      condition: service_healthy
    storage-init:
      condition: service_completed_successfully

services:
  web:
    environment:
      - APP_ENV=test
      - PRISM_API_LB_PORT=${PRISM_API_LB_PORT}
      - STREAM_SERVICE_PORT=${STREAM_SERVICE_PORT}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      prism-api-lb:
        condition: service_started
      stream-service:
        condition: service_started

  prism-api-1:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      PORT: "${PRISM_API_PORT1}"
    expose:
      - "${PRISM_API_PORT1}"
    restart: unless-stopped

  prism-api-2:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      PORT: "${PRISM_API_PORT2}"
    expose:
      - "${PRISM_API_PORT2}"
    restart: unless-stopped

  prism-api-3:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      PORT: "${PRISM_API_PORT3}"
    expose:
      - "${PRISM_API_PORT3}"
    restart: unless-stopped

  prism-api-4:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      PORT: "${PRISM_API_PORT4}"
    expose:
      - "${PRISM_API_PORT4}"
    restart: unless-stopped

  prism-api-5:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      PORT: ${PRISM_API_PORT5}
    expose:
      - "${PRISM_API_PORT5}"
    restart: unless-stopped

  prism-api-lb:
    environment:
      PRISM_API_LB_PORT: ${PRISM_API_LB_PORT}
      PRISM_API_PORT1: ${PRISM_API_PORT1}
      PRISM_API_PORT2: ${PRISM_API_PORT2}
      PRISM_API_PORT3: ${PRISM_API_PORT3}
      PRISM_API_PORT4: ${PRISM_API_PORT4}
      PRISM_API_PORT5: ${PRISM_API_PORT5}
    image: haproxy:3.0-alpine
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "${PRISM_API_LB_PORT}:${PRISM_API_LB_PORT}"
    depends_on:
      - prism-api-1
      - prism-api-2
      - prism-api-3
      - prism-api-4
      - prism-api-5

  stream-service:
    environment:
      APP_ENV: test
      AUTH0_TEST_MODE: 1
      TEST_JWT_SECRET: ${TEST_JWT_SECRET}
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    ports:
      - "${STREAM_SERVICE_PORT}:${STREAM_SERVICE_PORT}"
  domain-service-1:
    <<: *domain-service-base
    environment:
      <<: *domain-service-env

  domain-service-2:
    <<: *domain-service-base
    environment:
      <<: *domain-service-env

  domain-service-3:
    <<: *domain-service-base
    environment:
      <<: *domain-service-env

  domain-service-4:
    <<: *domain-service-base
    environment:
      <<: *domain-service-env

  domain-service-5:
    <<: *domain-service-base
    environment:
      <<: *domain-service-env
  
  read-model-updater:
    environment:
      APP_ENV: test
      AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING}
      AzureWebJobsScriptRoot: /home/site/wwwroot
      AzureFunctionsJobHost__Logging__Console__IsEnabled: true
      AzureFunctionsJobHost__Logging__LogLevel__Default: ${AZ_FUNC_JOB_HOST_LOG_LEVEL}
      FUNCTIONS_WORKER_RUNTIME: custom
      ASPNETCORE_URLS: http://+:${READ_MODEL_UPDATER_PORT}
      TASKS_PAGE_SIZE: ${TASKS_PAGE_SIZE}
    ports:
      - "${READ_MODEL_UPDATER_PORT}:${READ_MODEL_UPDATER_PORT}"
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      redis:
        condition: service_started

  storage-init:
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    restart: "no"

  redis:
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy

  azurite:
    command: ["azurite", "-s", "-l", "--inMemoryPersistence", "--skipApiVersionCheck", "/data", "--blobHost", "0.0.0.0"]

volumes:
  azurite_data:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs

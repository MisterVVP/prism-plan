x-prism-api: &prism-api-base
  environment: &prism-api-env
    APP_ENV: test
    AUTH0_TEST_MODE: "1"
    TEST_JWT_SECRET: ${TEST_JWT_SECRET}
    REDIS_CONNECTION_STRING: ${REDIS_CONNECTION_STRING}
    AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING}
    AzureWebJobsScriptRoot: /home/site/wwwroot
    AzureFunctionsJobHost__Logging__Console__IsEnabled: "true"
    FUNCTIONS_WORKER_RUNTIME: custom
    ENQUEUE_WORKERS: ${ENQUEUE_WORKERS}
    ENQUEUE_BUFFER: ${ENQUEUE_BUFFER}
    ENQUEUE_TIMEOUT: ${ENQUEUE_TIMEOUT}
    DEDUPER_TTL: ${DEDUPER_TTL}
  depends_on:
    azurite:
      condition: service_healthy
    fauxzureq:
      condition: service_healthy
    storage-init:
      condition: service_completed_successfully

services:
  web:
    environment:
      - APP_ENV=test
      - PRISM_API_LB_PORT=${PRISM_API_LB_PORT}
      - STREAM_SERVICE_PORT=${STREAM_SERVICE_PORT}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthz"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      prism-api-lb:
        condition: service_started
      stream-service:
        condition: service_started

  prism-api-1:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      ASPNETCORE_URLS: http://+:7072
    expose:
      - "7072"
    restart: unless-stopped

  prism-api-2:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      ASPNETCORE_URLS: http://+:7073
    expose:
      - "7073"
    restart: unless-stopped

  prism-api-3:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      ASPNETCORE_URLS: http://+:7074
    expose:
      - "7074"
    restart: unless-stopped

  prism-api-4:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      ASPNETCORE_URLS: http://+:7075
    expose:
      - "7075"
    restart: unless-stopped

  prism-api-5:
    <<: *prism-api-base
    environment:
      <<: *prism-api-env
      ASPNETCORE_URLS: http://+:7076
    expose:
      - "7076"
    restart: unless-stopped

  prism-api-lb:
    environment:
      PRISM_API_LB_PORT: ${PRISM_API_LB_PORT}
    image: haproxy:3.0-alpine
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "${PRISM_API_LB_PORT}:${PRISM_API_LB_PORT}"
    depends_on:
      - prism-api-1
      - prism-api-2
      - prism-api-3
      - prism-api-4
      - prism-api-5

  stream-service:
    environment:
      APP_ENV: test
      AUTH0_TEST_MODE: 1
      TEST_JWT_SECRET: ${TEST_JWT_SECRET}
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    ports:
      - "${STREAM_SERVICE_PORT}:${STREAM_SERVICE_PORT}"
  domain-service:
    environment:
      APP_ENV: test
      AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING}
      AzureWebJobsScriptRoot: /home/site/wwwroot
      AzureFunctionsJobHost__Logging__Console__IsEnabled: true
      AzureFunctionsJobHost__Logging__LogLevel__Default: ${AZ_FUNC_JOB_HOST_LOG_LEVEL}
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
  read-model-updater:
    environment:
      APP_ENV: test
      AzureWebJobsStorage: ${STORAGE_CONNECTION_STRING}
      AzureWebJobsScriptRoot: /home/site/wwwroot
      AzureFunctionsJobHost__Logging__Console__IsEnabled: true
      AzureFunctionsJobHost__Logging__LogLevel__Default: ${AZ_FUNC_JOB_HOST_LOG_LEVEL}
      FUNCTIONS_WORKER_RUNTIME: custom
      ASPNETCORE_URLS: http://+:${READ_MODEL_UPDATER_PORT}
    ports:
      - "${READ_MODEL_UPDATER_PORT}:${READ_MODEL_UPDATER_PORT}"
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
      storage-init:
        condition: service_completed_successfully
      redis:
        condition: service_started

  storage-init:
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy
    restart: "no"

  redis:
    environment:
      APP_ENV: test
    depends_on:
      fauxzureq:
        condition: service_healthy    
      azurite:
        condition: service_healthy

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    healthcheck:
      test: nc 127.0.0.1 10000 -z
      interval: 5s
      timeout: 3s
      retries: 5
    command: ["azurite", "-s", "-l", "--skipApiVersionCheck", "/data", "--blobHost", "0.0.0.0", "--tableHost", "0.0.0.0"]
    ports:
      - "10000:10000"
      - "10002:10002"

  fauxzureq:
    image: mistervvp/fauxzureq:latest
    command: ["--listen=:10001", "--account=devstoreaccount1", "--queue-delete-hold-ms=0"]
    ports: ["10001:10001"]
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:10001/__health"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  azurite_data:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs

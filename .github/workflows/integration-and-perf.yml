---
# yamllint disable rule:line-length
name: Integration and Performance

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      run_performance:
        description: "Enable performance testing"
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * *'

env:
  ENV_FILE: tests/docker/env.test

jobs:
  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - run: |
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml up -d
          set -a
          source $ENV_FILE
          PRISM_API_BASE=http://localhost:${PRISM_API_LB_PORT}
          STREAM_SERVICE_BASE=http://localhost:${STREAM_SERVICE_PORT}
          ENABLE_DOCKER_CMDS=1
          set +a
          tests/docker/wait-for.sh ${PRISM_API_BASE}${AZ_FUNC_HEALTH_ENDPOINT} 60
          tests/docker/wait-for.sh ${STREAM_SERVICE_BASE}${API_HEALTH_ENDPOINT} 60
          pushd tests/integration
          go test -v -coverprofile=integration.out $(go list ./... | grep -v /internal/)
          go tool cover -func=integration.out
          popd
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml down -v

  perf:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_performance == 'true' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - uses: grafana/setup-k6-action@v1
      - run: |
          set -a
          source $ENV_FILE
          tests/scripts/run-perf-api.sh
          tests/scripts/run-perf-sse.sh
          set +a
      - uses: actions/upload-artifact@v4
        with:
          name: k6-summary
          path: k6-summary.json
      - uses: actions/upload-artifact@v4
        with:
          name: sse-summary
          path: tests/perf_sse_summary.txt

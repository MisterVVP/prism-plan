name: Integration and Performance

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      run_performance:
        description: "Enable performance testing"
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * *'

jobs:
  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - run: |
          ENV_FILE=tests/docker/env.test
          source $ENV_FILE
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml up -d
          tests/docker/wait-for.sh http://localhost:${PRISM_API_PORT}${AZ_FUNC_HEALTH_ENDPOINT} 60
          tests/docker/wait-for.sh http://localhost:${STREAM_SERVICE_PORT}${API_HEALTH_ENDPOINT} 60
          pushd tests/integration
          STREAM_SERVICE_BASE=http://localhost:${STREAM_SERVICE_PORT}
          PRISM_API_BASE=http://localhost:${PRISM_API_PORT} go test -v -coverprofile=integration.out $(go list ./... | grep -v /internal/)
          go tool cover -func=integration.out
          popd
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml down -v

  perf:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_performance == 'true' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - uses: grafana/setup-k6-action@v1
      - run: |
          ENV_FILE=tests/docker/env.test
          source $ENV_FILE
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml up -d
          tests/docker/wait-for.sh http://localhost:${PRISM_API_PORT}${AZ_FUNC_HEALTH_ENDPOINT} 60
          STREAM_SERVICE_BASE=http://localhost:${STREAM_SERVICE_PORT}
          PRISM_API_BASE=http://localhost:${PRISM_API_PORT} k6 run tests/perf/k6/api_mixed_read_write.js --summary-export=k6-summary.json
          STREAM_URL=http://localhost:${STREAM_SERVICE_PORT}/stream go run tests/perf/sse-load/main.go > tests/perf_sse_summary.txt
          docker compose --env-file $ENV_FILE -f docker-compose.yml -f tests/docker/docker-compose.tests.yml down -v
      - uses: actions/upload-artifact@v3
        with:
          name: k6-summary
          path: k6-summary.json
      - uses: actions/upload-artifact@v3
        with:
          name: sse-summary
          path: tests/perf_sse_summary.txt
